#!/bin/sh
# $Id$
# Copyright (c) 2005-2008 Alexander Chernov <cher@ejudge.ru>

LANG_CONFIG_DIR="@ac_cv_lang_config_dir_expanded@"

function failure()
{
  rm -f conftest*
  echo 'enable_prolog=false'
  echo 'short_name_prolog="prolog"'
  echo 'GPLCRUN=false'
  echo 'GPROLOGDIR='
  echo 'GPROLOGVER='
  [ "${verbose}" = 1 ] && echo "no" >&2
  exit 1
}

if [ x"$1" = x-v ]
then
  verbose=1
  shift
fi

# recheck the language
if [ x"$1" = x-r ]
then
  [ x"$2" != x ] && GPLCRUN="$2"
  [ "${GPLCRUN}" = "" ] && GPLCRUN="gplc"

  [ "${verbose}" = 1 ] && echo -n "checking whether GNU Prolog is available..." >&2
  "${GPLCRUN}" --version >/dev/null 2>&1 || failure
  GPROLOGVER=`"${GPLCRUN}" --version 2>&1 | grep "Prolog compiler" | gawk '{ print $5; }'` || failure
  [ "${GPROLOGVER}" != "" ] || failure
  cat > conftest.pro <<EOF
:-initialization(main).
main :- write('OK'), halt.
EOF
  "${GPLCRUN}" -L --no-top-level conftest.pro -o conftest >/dev/null 2>&1 || failure
  [ -x conftest ] || failure
  ./conftest >/dev/null 2>&1 || failure

  rm -f ./conftest*
  GPROLOGDIR=`dirname "${GPLCRUN}"`
  [ "${GPROLOGDIR}" = . ] && GPROLOGDIR=""
  echo 'enable_prolog=true'
  echo 'short_name_prolog="prolog"'
  echo 'GPLCRUN="'"${GPLCRUN}"'"'
  echo 'GPROLOGDIR="'"${GPROLOGDIR}"'"'
  echo 'GPROLOGVER="'"${GPROLOGVER}"'"'
  [ "${verbose}" = 1 ] && echo "yes, ${GPLCRUN}, ${GPROLOGVER}" >&2
  exit 0
fi

[ "${EJUDGE_LANG_CONFIG}" = "" ] && EJUDGE_LANG_CONFIG="${LANG_CONFIG_DIR}/gprolog.cfg"

if [ -f "${EJUDGE_LANG_CONFIG}" ]
then
  . "${EJUDGE_LANG_CONFIG}"
else
  GPLCRUN="gplc"
  GPROLOGDIR=""
fi

if [ x"${GPLCRUN}" = x -o x"${GPLCRUN}" = xfalse ]
then
  echo "This language is not supported." >&2
  exit 1
fi

if [ x"${GPROLOGDIR}" != x ]
then
    PATH="${GPROLOGDIR}:${PATH}"
fi

if [ x"$1" = x-p ]
then
    echo "${GPLCRUN}"
    exit 0
fi
    
"${GPLCRUN}" --version 2>/dev/null >/dev/null || exit 1

[ x"$1" = x-f ] && echo -n "GNU Prolog "

"${GPLCRUN}" --version 2>&1 | grep "Prolog compiler" | gawk '{ print $5; }'
[ $? != 0 -a $? != 1 ] && exit 1
exit 0
