#!/bin/bash
# $Id$
# Copyright (c) 2004 Alexander Chernov

# assume that we have single argument
# EJUDGE_JAVA_FLAGS may be used to pass additional flags
# EJUDGE_JAVA_POLICY is the policy name
# EJUDGE_PREFIX_DIR is used to create the full path

runfile="$1"

JAVARUN="@ac_cv_contest_java@"
JAVADIR="@ac_cv_contest_java_dir@"
JAVAVER="@ac_cv_contest_java_version@"

JAVA_HOME="${JAVADIR}"
PATH="${JAVA_HOME}/bin:${PATH}"
export JAVA_HOME PATH

if [ x"${EJUDGE_JAVA_POLICY}" = xnone ]
then
  # no securuty policy, use with caution!
  mv "$1" Main.jar || exit 128
  exec "${JAVARUN}" ${EJUDGE_JAVA_FLAGS} -cp ./Main.jar Main
fi

[ x"${EJUDGE_JAVA_POLICY}" = x ] && EJUDGE_JAVA_POLICY=default.policy

if [ -f "${EJUDGE_JAVA_POLICY}" ]
then
  policy_file="${EJUDGE_JAVA_POLICY}"
else
  if [ x"${EJUDGE_PREFIX_DIR}" = x ]
  then
    echo "EJUDGE_PREFIX_DIR is not set - impossible to set securuty policy" >&2
    exit 128
  fi
  policy_file="${EJUDGE_PREFIX_DIR}/share/ejudge/${EJUDGE_JAVA_POLICY}"
fi

if [ ! -f "${policy_file}" ]
then
  echo "Java policy file does not exist" >&2
  exit 128
fi

mv "$1" Main.jar || exit 128
exec "${JAVARUN}" ${EJUDGE_JAVA_FLAGS} -cp ./Main.jar -Djava.security.manager -Djava.security.policy="${policy_file}" Main
