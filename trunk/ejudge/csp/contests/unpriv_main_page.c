/* === string pool === */

static const unsigned char csp_str0[184] = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html><head>\n<meta http-equiv=\"Content-type\" content=\"text/html; charset=";
static const unsigned char csp_str1[41] = "\"/>\n<script type=\"text/javascript\" src=\"";
static const unsigned char csp_str2[82] = "dojo/dojo.js\" djConfig=\"isDebug: false, parseOnLoad: true, dojoIframeHistoryUrl:\'";
static const unsigned char csp_str3[84] = "dojo/resources/iframe_history.html\'\"></script>\n<script type=\"text/javascript\" src=\"";
static const unsigned char csp_str4[65] = "unpriv.js\"></script>\n<script type=\"text/javascript\">\n  var SID=\"";
static const unsigned char csp_str5[41] = "\";\n  var NEW_SRV_ACTION_JSON_USER_STATE=";
static const unsigned char csp_str6[45] = ";\n  var NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY=";
static const unsigned char csp_str7[19] = ";\n  var self_url=\"";
static const unsigned char csp_str8[23] = "\";\n  var script_name=\"";
static const unsigned char csp_str9[35] = "\";\n  dojo.require(\"dojo.parser\");\n";
static const unsigned char csp_str10[19] = "  var jsonState = ";
static const unsigned char csp_str11[3] = ";\n";
static const unsigned char csp_str12[30] = "  var updateFailedMessage = \"";
static const unsigned char csp_str13[38] = "\";\n  var testingInProgressMessage = \"";
static const unsigned char csp_str14[30] = "\";\n  var testingCompleted = \"";
static const unsigned char csp_str15[28] = "\";\n  var waitingTooLong = \"";
static const unsigned char csp_str16[43] = "\";\n</script>\n<link rel=\"stylesheet\" href=\"";
static const unsigned char csp_str17[38] = "unpriv.css\" type=\"text/css\"/>\n<title>";
static const unsigned char csp_str18[3] = " [";
static const unsigned char csp_str19[4] = "]: ";
static const unsigned char csp_str20[22] = "</title></head>\n<body";
static const unsigned char csp_str21[23] = " onload=\"startClock()\"";
static const unsigned char csp_str22[62] = "><div id=\"container\"><div id=\"l12\">\n<div class=\"main_phrase\">";
static const unsigned char csp_str23[8] = "</div>\n";
static const unsigned char csp_str24[52] = "<div class=\"user_actions\">\n<table class=\"menu\"><tr>";
static const unsigned char csp_str25[52] = "<td class=\"menu\"><div class=\"contest_actions_item\">";
static const unsigned char csp_str26[12] = "</div></td>";
static const unsigned char csp_str27[17] = "]</a></div></td>";
static const unsigned char csp_str28[69] = "<td class=\"menu\"><div class=\"contest_actions_item\">&nbsp;</div></td>";
static const unsigned char csp_str29[171] = "</tr></table>\n</div>\n<div class=\"white_empty_block\">&nbsp;</div>\n<div class=\"contest_actions\">\n<table class=\"menu\"><tr><td class=\"menu\"><div class=\"contest_actions_item\">";
static const unsigned char csp_str30[39] = "<a:a class=\"menu\" ac=\"view-startstop\">";
static const unsigned char csp_str31[23] = "<a class=\"menu\" href=\"";
static const unsigned char csp_str32[19] = "\" target=\"_blank\">";
static const unsigned char csp_str33[5] = "</a>";
static const unsigned char csp_str34[53] = "</tr></table>\n</div>\n</div>\n<div id=\"l11\"><img src=\"";
static const unsigned char csp_str35[45] = "logo.gif\" alt=\"logo\"/></div>\n<div id=\"l13\">\n";
static const unsigned char csp_str36[12] = "<div class=";
static const unsigned char csp_str37[20] = "\"server_status_off\"";
static const unsigned char csp_str38[22] = "\"server_status_alarm\"";
static const unsigned char csp_str39[19] = "\"server_status_on\"";
static const unsigned char csp_str40[41] = " id=\"statusLine\">\n<div id=\"currentTime\">";
static const unsigned char csp_str41[7] = "</div>";
static const unsigned char csp_str42[7] = " / <b>";
static const unsigned char csp_str43[16] = "EXAM IS RUNNING";
static const unsigned char csp_str44[8] = "RUNNING";
static const unsigned char csp_str45[12] = "NOT STARTED";
static const unsigned char csp_str46[5] = "</b>";
static const unsigned char csp_str47[6] = "/ <b>";
static const unsigned char csp_str48[25] = " / <b><font color=\"red\">";
static const unsigned char csp_str49[12] = "</font></b>";
static const unsigned char csp_str50[4] = " / ";
static const unsigned char csp_str51[3] = ": ";
static const unsigned char csp_str52[27] = ": <div id=\"remainingTime\">";
static const unsigned char csp_str53[43] = "<div id=\"reloadButton\" style=\"visibility: ";
static const unsigned char csp_str54[8] = "visible";
static const unsigned char csp_str55[7] = "hidden";
static const unsigned char csp_str56[49] = "\">/ <a class=\"menu\" onclick=\"reloadPage()\"><b>[ ";
static const unsigned char csp_str57[80] = " ]</b></a></div><div id=\"statusString\" style=\"visibility: hidden\"></div></div>\n";
static const unsigned char csp_str58[31] = "<br/>\n<table class=\"probNav\">\n";
static const unsigned char csp_str59[86] = "<tr id=\"probNavTopList\"><td width=\"100%\" class=\"nTopNavList\"><ul class=\"nTopNavList\">";
static const unsigned char csp_str60[26] = "<li id=\"nTopNavSelected\">";
static const unsigned char csp_str61[5] = "<li>";
static const unsigned char csp_str62[27] = "<div class=\"nProbCurrent\">";
static const unsigned char csp_str63[25] = "<div class=\"nProbEmpty\">";
static const unsigned char csp_str64[25] = "<div class=\"nProbTrans\">";
static const unsigned char csp_str65[22] = "<div class=\"nProbOk\">";
static const unsigned char csp_str66[28] = "<div class=\"nProbDisabled\">";
static const unsigned char csp_str67[23] = "<div class=\"nProbBad\">";
static const unsigned char csp_str68[12] = "</div></li>";
static const unsigned char csp_str69[85] = "</ul></td></tr>\n<tr><td id=\"probNavTaskArea\" valign=\"top\"><div id=\"probNavTaskArea\">";
static const unsigned char csp_str70[80] = "<tr><td class=\"b0\" id=\"probNavTaskArea\" valign=\"top\"><div id=\"probNavTaskArea\">";
static const unsigned char csp_str71[2] = "\n";
static const unsigned char csp_str72[5] = "<h2>";
static const unsigned char csp_str73[13] = "</h2>\n<p><b>";
static const unsigned char csp_str74[11] = "</b></p>\n\n";
static const unsigned char csp_str75[7] = "<p><b>";
static const unsigned char csp_str76[9] = "</b></p>";
static const unsigned char csp_str77[3] = "\n\n";
static const unsigned char csp_str78[41] = "\n\n<table class=\"b0\">\n<tr><td class=\"b0\">";
static const unsigned char csp_str79[22] = ":</td><td class=\"b0\">";
static const unsigned char csp_str80[12] = "</td></tr>\n";
static const unsigned char csp_str81[20] = "<tr><td class=\"b0\">";
static const unsigned char csp_str82[16] = "<td class=\"b0\">";
static const unsigned char csp_str83[11] = "</td></tr>";
static const unsigned char csp_str84[11] = "\n</table>\n";
static const unsigned char csp_str85[10] = "</b></p>\n";
static const unsigned char csp_str86[3] = ", ";
static const unsigned char csp_str87[4] = "<p>";
static const unsigned char csp_str88[5] = "</p>";
static const unsigned char csp_str89[10] = "</h2>\n<p>";
static const unsigned char csp_str90[7] = "</h2>\n";
static const unsigned char csp_str91[2] = " ";
static const unsigned char csp_str92[24] = "<pre><font color=\"red\">";
static const unsigned char csp_str93[14] = "</font></pre>";
static const unsigned char csp_str94[13] = "<p><a href=\"";
static const unsigned char csp_str95[10] = "</a></p>\n";
static const unsigned char csp_str96[6] = "\n<h2>";
static const unsigned char csp_str97[40] = "\n<table class=\"b0\">\n<tr><td class=\"b0\">";
static const unsigned char csp_str98[21] = "</td><td class=\"b0\">";
static const unsigned char csp_str99[20] = "</td></tr></table>\n";
static const unsigned char csp_str100[5] = "<h3>";
static const unsigned char csp_str101[7] = "</h3>\n";
static const unsigned char csp_str102[27] = "<big><font color=\"red\"><p>";
static const unsigned char csp_str103[19] = "</p></font></big>\n";
static const unsigned char csp_str104[21] = "\n<table class=\"b0\">\n";
static const unsigned char csp_str105[21] = "\n<tr><td class=\"b0\">";
static const unsigned char csp_str106[4] = " - ";
static const unsigned char csp_str107[27] = "<option value=\"\"></option>";
static const unsigned char csp_str108[30] = "\n<option value=\"0\"></option>\n";
static const unsigned char csp_str109[16] = "LF (Unix/MacOS)";
static const unsigned char csp_str110[19] = "CRLF (Windows/DOS)";
static const unsigned char csp_str111[101] = "<tr><td colspan=\"2\" class=\"b0\"><textarea name=\"text_form\" rows=\"20\" cols=\"60\"></textarea></td></tr>\n";
static const unsigned char csp_str112[64] = "</td><td class=\"b0\"><input type=\"file\" name=\"file\"/></td></tr>\n";
static const unsigned char csp_str113[65] = "</td><td class=\"b0\"><input type=\"text\" name=\"file\" /></td></tr>\n";
static const unsigned char csp_str114[96] = "<tr><td colspan=\"2\" class=\"b0\"><textarea name=\"file\" rows=\"20\" cols=\"60\"></textarea></td></tr>\n";
static const unsigned char csp_str115[27] = "</td></tr></table></form>\n";
static const unsigned char csp_str116[3] = " (";
static const unsigned char csp_str117[8] = ")</h2>\n";
static const unsigned char csp_str118[26] = "\n<table class=\"b0\">\n<tr>\n";
static const unsigned char csp_str119[6] = "</td>";
static const unsigned char csp_str120[15] = "</tr></table>\n";
static const unsigned char csp_str121[6] = "\n    ";
static const unsigned char csp_str122[5] = "\n<p>";
static const unsigned char csp_str123[6] = "</p>\n";
static const unsigned char csp_str124[39] = "\n<table class=\"b0\"><tr><td class=\"b0\">";
static const unsigned char csp_str125[31] = "</td></tr>\n<tr><td class=\"b0\">";
static const unsigned char csp_str126[138] = "</td></tr>\n<tr><td colspan=\"2\" class=\"b0\"><textarea name=\"text\" rows=\"20\" cols=\"60\"></textarea></td></tr>\n<tr><td colspan=\"2\" class=\"b0\">";
static const unsigned char csp_str127[21] = "</td></tr>\n</table>\n";
static const unsigned char csp_str128[43] = "</td></tr>\n<tr><td class=\"b0\" colspan=\"2\">";
static const unsigned char csp_str129[20] = "</td></tr>\n</table>";
static const unsigned char csp_str130[22] = "</td>\n<td class=\"b0\">";
static const unsigned char csp_str131[62] = "</div></td><td class=\"b0\" id=\"probNavRightList\" valign=\"top\">";
static const unsigned char csp_str132[27] = "<div class=\"probDisabled\">";
static const unsigned char csp_str133[26] = "<div class=\"probCurrent\">";
static const unsigned char csp_str134[24] = "<div class=\"probEmpty\">";
static const unsigned char csp_str135[24] = "<div class=\"probTrans\">";
static const unsigned char csp_str136[21] = "<div class=\"probOk\">";
static const unsigned char csp_str137[22] = "<div class=\"probBad\">";
static const unsigned char csp_str138[112] = "</div></td></tr>\n<tr id=\"probNavBottomList\"><td width=\"100%\" class=\"nBottomNavList\"><ul class=\"nBottomNavList\">";
static const unsigned char csp_str139[29] = "<li id=\"nBottomNavSelected\">";
static const unsigned char csp_str140[25] = "</ul></td></tr></table>\n";
static const unsigned char csp_str141[18] = "<div id=\"footer\">";
static const unsigned char csp_str142[38] = "</div>\n</div>\n</div>\n</body>\n</html>\n";

/* $Id$ */
#include "new-server.h"
#include "new_server_pi.h"
#include "new_server_proto.h"
#include "external_action.h"
#include "clarlog.h"
#include "misctext.h"
#include "runlog.h"
#include "l10n.h"
#include "prepare.h"
#include "xml_utils.h"
#include "teamdb.h"
#include "copyright.h"
#include "mischtml.h"
#include "html.h"
#include "userlist.h"
#include "sformat.h"

#include "reuse/xalloc.h"

#include <libintl.h>
#define _(x) gettext(x)

#define FAIL(c) do { retval = -(c); goto cleanup; } while (0)

void
unpriv_load_html_style(struct http_request_info *phr,
                       const struct contest_desc *cnts,
                       struct contest_extra **p_extra,
                       time_t *p_cur_time);
void
do_json_user_state(FILE *fout, const serve_state_t cs, int user_id,
                   int need_reload_check);
#include "compat.h"

void
ns_unparse_statement(
        FILE *fout,
        struct http_request_info *phr,
        const struct contest_desc *cnts,
        struct contest_extra *extra,
        const struct section_problem_data *prob,
        int variant,
        problem_xml_t px,
        const unsigned char *bb,
        int is_submittable);

void
ns_unparse_answers(
        FILE *fout,
        struct http_request_info *phr,
        const struct contest_desc *cnts,
        struct contest_extra *extra,
        const struct section_problem_data *prob,
        int variant,
        problem_xml_t px,
        const unsigned char *lang,
        int is_radio,
        int last_answer,
        int next_prob_id,
        int enable_js,
        const unsigned char *class_name);
int csp_view_unpriv_main_page(PageInterface *ps, FILE *log_f, FILE *out_f, struct http_request_info *phr);
static PageInterfaceOps page_ops =
{
    NULL, // destroy
    NULL, // execute
    csp_view_unpriv_main_page, // render
};
static PageInterface page_iface =
{
    &page_ops,
};
PageInterface *
csp_get_unpriv_main_page(void)
{
    return &page_iface;
}

int csp_view_unpriv_main_page(PageInterface *ps, FILE *log_f, FILE *out_f, struct http_request_info *phr)
{
int retval __attribute__((unused)) = 0;
  struct contest_extra *extra __attribute__((unused)) = phr?phr->extra:NULL;
  serve_state_t cs __attribute__((unused)) = extra?extra->serve_state:NULL;
  const struct contest_desc *cnts __attribute__((unused)) = phr?phr->cnts:NULL;
  struct html_armor_buffer ab __attribute__((unused)) = HTML_ARMOR_INITIALIZER;
  unsigned char hbuf[1024] __attribute__((unused));
  const unsigned char *sep __attribute__((unused)) = NULL;
  unsigned char time_buf[256] __attribute__((unused));
  int unread_clars __attribute__((unused)) = 0;
  int shown_items __attribute__((unused)) = 0;
  time_t sched_time __attribute__((unused)) = 0;
  time_t duration __attribute__((unused)) = 0;
  time_t fog_start_time __attribute__((unused)) = 0;
  struct teamdb_export tdb __attribute__((unused));
  struct sformat_extra_data fe __attribute__((unused));
  const struct section_global_data *global __attribute__((unused)) = cs?cs->global:NULL;
  time_t start_time __attribute__((unused)) = 0, stop_time __attribute__((unused)) = 0;
time_t finish_time = 0;
  const unsigned char *s;
  int all_runs = 0, all_clars = 0;
  unsigned char *solved_flag = 0;
  unsigned char *accepted_flag = 0;
  unsigned char *pending_flag = 0;
  unsigned char *trans_flag = 0;
  unsigned char *pr_flag = NULL;
  unsigned char *prob_status = 0;
  time_t *prob_deadline = 0;
  int *best_run = 0;
  int *attempts = 0;
  int *disqualified = 0;
  int *best_score = 0;
  int *prev_successes = 0;
  int *all_attempts = 0;
  int n, v, prob_id = 0, i, j, variant = 0;
  char **lang_list;
  path_t variant_stmt_file;
  struct watched_file *pw = 0;
  const unsigned char *pw_path;
  const struct section_problem_data *prob = 0, *prob2;
  unsigned char bb[1024];
  int lang_count = 0, lang_id = 0;
  int first_prob_id, last_prob_id;
  int accepting_mode = 0;
  const unsigned char *cc = 0;
  int last_answer = -1, last_lang_id, skip_start_form = 0;
  unsigned char *last_source = 0;
  unsigned char dbuf[1024];
  int upper_tab_id = 0, next_prob_id;
  problem_xml_t px;
  unsigned char prev_group_name[256] = { 0 };
  const unsigned char *title = NULL;
  int enable_virtual_start = 0;

  if (hr_cgi_param(phr, "all_runs", &s) > 0
      && sscanf(s, "%d%n", &v, &n) == 1 && !s[n] && v >= 0 && v <= 1) {
    phr->session_extra->user_view_all_runs = v;
  }
  all_runs = phr->session_extra->user_view_all_runs;
  if (hr_cgi_param(phr, "all_clars", &s) > 0
      && sscanf(s, "%d%n", &v, &n) == 1 && !s[n] && v >= 0 && v <= 1) {
    phr->session_extra->user_view_all_clars = v;
  }
  all_clars = phr->session_extra->user_view_all_clars;
  if (hr_cgi_param(phr, "prob_id", &s) > 0
      && sscanf(s, "%d%n", &v, &n) == 1 && !s[n] && v >= -1)
    prob_id = v;
  
  XALLOCAZ(solved_flag, cs->max_prob + 1);
  XALLOCAZ(accepted_flag, cs->max_prob + 1);
  XALLOCAZ(pending_flag, cs->max_prob + 1);
  XALLOCAZ(trans_flag, cs->max_prob + 1);
  XALLOCAZ(pr_flag, cs->max_prob + 1);
  XALLOCA(best_run, cs->max_prob + 1);
  memset(best_run, -1, (cs->max_prob + 1) * sizeof(best_run[0]));
  XALLOCAZ(attempts, cs->max_prob + 1);
  XALLOCAZ(disqualified, cs->max_prob + 1);
  XALLOCAZ(best_score, cs->max_prob + 1);
  XALLOCAZ(prev_successes, cs->max_prob + 1);
  XALLOCAZ(all_attempts, cs->max_prob + 1);
  XALLOCAZ(prob_status, cs->max_prob + 1);
  XALLOCAZ(prob_deadline, cs->max_prob + 1);

  if (global->is_virtual) {
    start_time = run_get_virtual_start_time(cs->runlog_state, phr->user_id);
    stop_time = run_get_virtual_stop_time(cs->runlog_state, phr->user_id,
                                          cs->current_time);
    if (stop_time <= 0) accepting_mode = 1;
  } else {
    start_time = run_get_start_time(cs->runlog_state);
    stop_time = run_get_stop_time(cs->runlog_state);
    accepting_mode = cs->accepting_mode;
  }
  run_get_times(cs->runlog_state, 0, &sched_time, &duration, 0, &finish_time);
  if (duration > 0 && start_time && !stop_time && global->board_fog_time > 0)
    fog_start_time = start_time + duration - global->board_fog_time;
  if (fog_start_time < 0) fog_start_time = 0;

  if (phr->action == NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY) {
    title = _("Problem summary");
  } else if (phr->action == NEW_SRV_ACTION_VIEW_PROBLEM_STATEMENTS) {
    title = _("Statements");
  } else if (phr->action == NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT) {
    title = _("Submit a solution");
  } else if (phr->action == NEW_SRV_ACTION_VIEW_SUBMISSIONS) {
    title = _("Submissions");
  } else if (phr->action == NEW_SRV_ACTION_VIEW_CLAR_SUBMIT) {
    title = _("Send a message");
  } else if (phr->action == NEW_SRV_ACTION_VIEW_CLARS) {
    title = _("Messages");
  } else if (phr->action == NEW_SRV_ACTION_VIEW_SETTINGS) {
    title = _("Settings");
  } else {
    phr->action = NEW_SRV_ACTION_MAIN_PAGE;
    if (cnts->exam_mode > 0) {
      title = _("Exam status");
    } else {
      title = _("Contest status");
    }
  }

  l10n_setlocale(phr->locale_id);
  unpriv_load_html_style(phr, cnts, 0, 0);
fwrite(csp_str0, 1, 183, out_f);
fwrite("utf-8", 1, 5, out_f);
fwrite(csp_str1, 1, 40, out_f);
fwrite("/ejudge/", 1, 8, out_f);
fwrite(csp_str2, 1, 81, out_f);
fwrite("/ejudge/", 1, 8, out_f);
fwrite(csp_str3, 1, 83, out_f);
fwrite("/ejudge/", 1, 8, out_f);
fwrite(csp_str4, 1, 64, out_f);
fprintf(out_f, "%016llx", (phr->session_id));
fwrite(csp_str5, 1, 40, out_f);
fprintf(out_f, "%d", NEW_SRV_ACTION_JSON_USER_STATE);
fwrite(csp_str6, 1, 44, out_f);
fprintf(out_f, "%d", NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY);
fwrite(csp_str7, 1, 18, out_f);
fputs((phr->self_url), out_f);
fwrite(csp_str8, 1, 22, out_f);
fputs((phr->script_name), out_f);
fwrite(csp_str9, 1, 34, out_f);
#if defined CONF_ENABLE_AJAX && CONF_ENABLE_AJAX
  if (cs && phr->user_id > 0 ) {
fwrite(csp_str10, 1, 18, out_f);
do_json_user_state(out_f, cs, phr->user_id, 0);
fwrite(csp_str11, 1, 2, out_f);
}
#endif
fwrite(csp_str12, 1, 29, out_f);
fputs(_("STATUS UPDATE FAILED!"), out_f);
fwrite(csp_str13, 1, 37, out_f);
fputs(_("TESTING IN PROGRESS..."), out_f);
fwrite(csp_str14, 1, 29, out_f);
fputs(_("TESTING COMPLETED"), out_f);
fwrite(csp_str15, 1, 27, out_f);
fputs(_("REFRESH PAGE MANUALLY!"), out_f);
fwrite(csp_str16, 1, 42, out_f);
fwrite("/ejudge/", 1, 8, out_f);
fwrite(csp_str17, 1, 37, out_f);
if (phr) {
if ((phr->name_arm) ) {
fputs((phr->name_arm), out_f);
}
}
fwrite(csp_str18, 1, 2, out_f);
if (extra) {
if ((extra->contest_arm) ) {
fputs((extra->contest_arm), out_f);
}
}
fwrite(csp_str19, 1, 3, out_f);
fputs((title), out_f);
fwrite(csp_str20, 1, 21, out_f);
#if defined CONF_ENABLE_AJAX && CONF_ENABLE_AJAX
fwrite(csp_str21, 1, 22, out_f);
#endif
fwrite(csp_str22, 1, 61, out_f);
if (phr) {
if ((phr->name_arm) ) {
fputs((phr->name_arm), out_f);
}
}
fwrite(csp_str18, 1, 2, out_f);
if (extra) {
if ((extra->contest_arm) ) {
fputs((extra->contest_arm), out_f);
}
}
fwrite(csp_str19, 1, 3, out_f);
fputs((title), out_f);
fwrite(csp_str23, 1, 7, out_f);
fwrite(csp_str24, 1, 51, out_f);
shown_items = 0;
  if (cnts && cs && cnts->exam_mode <= 0) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_SETTINGS) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_SETTINGS);
fputs("\">", out_f);
}
fputs(_("Settings"), out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_SETTINGS) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
shown_items++;

    // reg data edit
    if (cnts->allow_reg_data_edit > 0
        && contests_check_register_ip_2(cnts, &phr->ip, phr->ssl_flag) > 0
        && (cnts->reg_deadline <= 0 || cs->current_time < cnts->reg_deadline)) {
      ns_get_register_url(hbuf, sizeof(hbuf), cnts, phr);
      fprintf(out_f, "<td class=\"menu\"><div class=\"contest_actions_item\"><a class=\"menu\" href=\"%s?SID=%016llx\">%s</a></div></td>",
              hbuf, phr->session_id, _("Registration data"));
      shown_items++;
    }

    // logout
fwrite(csp_str25, 1, 51, out_f);
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_LOGOUT);
fputs("\">", out_f);
if (cnts->exam_mode) {
fputs(_("Finish session"), out_f);
} else {
fputs(_("Logout"), out_f);
}
fwrite(csp_str18, 1, 2, out_f);
fputs((phr->login), out_f);
fwrite(csp_str27, 1, 16, out_f);
shown_items++;
  }

  if (!shown_items) {
fwrite(csp_str28, 1, 68, out_f);
}
fwrite(csp_str29, 1, 170, out_f);
if (phr->action != NEW_SRV_ACTION_MAIN_PAGE) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_MAIN_PAGE);
fputs("\">", out_f);
}
if (cnts && cnts->exam_mode) {
fputs(_("Instructions"), out_f);
} else {
fputs(_("Info"), out_f);
}
if (phr->action != NEW_SRV_ACTION_MAIN_PAGE) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
if (global && global->is_virtual > 0 && ((start_time <= 0 && global->disable_virtual_start <= 0) || stop_time <= 0)) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_STARTSTOP) {
fwrite(csp_str30, 1, 38, out_f);
}
if (start_time <= 0) {
      if (cnts->exam_mode) {
fputs(_("Start exam"), out_f);
} else {
fputs(_("Start virtual contest"), out_f);
}
    } else if (stop_time <= 0) {
      if (cnts->exam_mode) {
fputs(_("Stop exam"), out_f);
} else {
fputs(_("Stop virtual contest"), out_f);
}
    }
if (phr->action != NEW_SRV_ACTION_VIEW_STARTSTOP) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
if (cnts && start_time > 0 && (cnts->exam_mode <= 0 || stop_time > 0)) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY);
fputs("\">", out_f);
}
fputs(_("Summary"), out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
if (global && start_time > 0 && stop_time <= 0 && cnts->problems_url) {
//      && (stop_time <= 0 || cnts->problems_url)
//      && (global->problem_navigation <= 0 || cnts->problems_url)) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_PROBLEM_STATEMENTS) {
      if (cnts->problems_url) {
fwrite(csp_str31, 1, 22, out_f);
fputs((cnts->problems_url), out_f);
fwrite(csp_str32, 1, 18, out_f);
fputs(_("Statements"), out_f);
fwrite(csp_str33, 1, 4, out_f);
} else {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_STATEMENTS);
fputs("\">", out_f);
fputs(_("Statements"), out_f);
fputs("</a>", out_f);
}
    } else {
fputs(_("Statements"), out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
if (global && start_time > 0 && stop_time <= 0 && global->problem_navigation <= 0) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT);
fputs("\">", out_f);
}
fputs(_("Submit"), out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
if (cnts && start_time > 0 && (cnts->exam_mode <= 0 || stop_time > 0)) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_SUBMISSIONS) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_SUBMISSIONS);
fputs("\">", out_f);
}
fputs(_("Submissions"), out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_SUBMISSIONS) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
if (global && start_time > 0 && global->disable_user_standings <= 0) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action == NEW_SRV_ACTION_STANDINGS) {
if (cnts->personal) {
fputs(_("User standings"), out_f);
} else {
fputs(_("Standings"), out_f);
}
    } else {
      if (cnts->standings_url) {
        memset(&tdb, 0, sizeof(tdb));
        teamdb_export_team(cs->teamdb_state, phr->user_id, &tdb);
        memset(&fe, 0, sizeof(fe));
        fe.locale_id = phr->locale_id;
        fe.sid = phr->session_id;
        sformat_message(hbuf, sizeof(hbuf), 0,
                        cnts->standings_url, global, 0, 0, 0, &tdb,
                        tdb.user, cnts, &fe);
fwrite(csp_str31, 1, 22, out_f);
fputs((hbuf), out_f);
fwrite(csp_str32, 1, 18, out_f);
if (cnts->personal) {
fputs(_("User standings"), out_f);
} else {
fputs(_("Standings"), out_f);
}
fwrite(csp_str33, 1, 4, out_f);
} else {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_STANDINGS);
fputs("\">", out_f);
if (cnts->personal) {
fputs(_("User standings"), out_f);
} else {
fputs(_("Standings"), out_f);
}
fputs("</a>", out_f);
}
    }
fwrite(csp_str26, 1, 11, out_f);
}
if (global && global->disable_team_clars <= 0 && global->disable_clars <= 0 && start_time > 0
      && (stop_time <= 0 || (global->appeal_deadline > 0 && cs->current_time < global->appeal_deadline))) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_CLAR_SUBMIT) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_CLAR_SUBMIT);
fputs("\">", out_f);
}
fputs(_("Submit clar"), out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_CLAR_SUBMIT) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
if (global && global->disable_clars <= 0) {
fwrite(csp_str25, 1, 51, out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_CLARS) {
fputs("<a class=\"menu\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_CLARS);
fputs("\">", out_f);
}
fputs(_("Clars"), out_f);
if (phr->action != NEW_SRV_ACTION_VIEW_CLARS) {
fputs("</a>", out_f);
}
fwrite(csp_str26, 1, 11, out_f);
}
fwrite(csp_str34, 1, 52, out_f);
fwrite("/ejudge/", 1, 8, out_f);
fwrite(csp_str35, 1, 44, out_f);
run_get_times(cs->runlog_state, 0, &sched_time, &duration, 0, 0);
  if (duration > 0 && start_time && !stop_time && global->board_fog_time > 0)
    fog_start_time = start_time + duration - global->board_fog_time;
  if (fog_start_time < 0) fog_start_time = 0;
  if (!cs->global->disable_clars || !cs->global->disable_team_clars)
    unread_clars = serve_count_unread_clars(cs, phr->user_id, start_time);
fwrite(csp_str36, 1, 11, out_f);
if (cs->clients_suspended) {
fwrite(csp_str37, 1, 19, out_f);
} else if (unread_clars > 0) {
fwrite(csp_str38, 1, 21, out_f);
} else {
fwrite(csp_str39, 1, 18, out_f);
}
fwrite(csp_str40, 1, 40, out_f);
{
  struct tm *ptm = localtime(&(cs->current_time));
  fprintf(out_f, "%02d:%02d:%02d", ptm->tm_hour, ptm->tm_min, ptm->tm_sec);
}
fwrite(csp_str41, 1, 6, out_f);
if (unread_clars > 0) {
    fprintf(out_f, _(" / <b>%d unread message(s)</b>"),
            unread_clars);
  }
fwrite(csp_str42, 1, 6, out_f);
if (stop_time > 0) {
    if (duration > 0 && global->board_fog_time > 0
        && global->board_unfog_time > 0
        && cs->current_time < stop_time + global->board_unfog_time
        && !cs->standings_updated) {
fputs(_("OVER (frozen)"), out_f);
} else {
fputs(_("OVER"), out_f);
}
  } else if (start_time > 0) {
    if (fog_start_time > 0 && cs->current_time >= fog_start_time) {
      if (cnts->exam_mode) {
fputs(_("EXAM IS RUNNING (frozen)"), out_f);
} else {
fputs(_("RUNNING (frozen)"), out_f);
}
    } else {
      if (cnts->exam_mode) {
fwrite(csp_str43, 1, 15, out_f);
} else {
fwrite(csp_str44, 1, 7, out_f);
}
    }
  } else {
fwrite(csp_str45, 1, 11, out_f);
}
fwrite(csp_str46, 1, 4, out_f);
if (start_time > 0) {
    if (global->score_system == SCORE_OLYMPIAD && !global->is_virtual) {
fwrite(csp_str47, 1, 5, out_f);
if (cs->accepting_mode) {
fputs(_("accepting"), out_f);
} else if (!cs->testing_finished) {
fputs(_("judging"), out_f);
} else {
fputs(_("judged"), out_f);
}
fwrite(csp_str46, 1, 4, out_f);
}
  }
if (cs->upsolving_mode) {
fwrite(csp_str42, 1, 6, out_f);
fputs(_("UPSOLVING"), out_f);
fwrite(csp_str46, 1, 4, out_f);
}
if (cs->clients_suspended) {
fwrite(csp_str48, 1, 24, out_f);
fputs(_("clients suspended"), out_f);
fwrite(csp_str49, 1, 11, out_f);
}
if (start_time > 0) {
    if (cs->testing_suspended) {
fwrite(csp_str48, 1, 24, out_f);
fputs(_("testing suspended"), out_f);
fwrite(csp_str49, 1, 11, out_f);
}
    if (cs->printing_suspended) {
fwrite(csp_str48, 1, 24, out_f);
fputs(_("printing suspended"), out_f);
fwrite(csp_str49, 1, 11, out_f);
}
  }
if (!global->is_virtual && start_time <= 0 && sched_time > 0) {
fwrite(csp_str50, 1, 3, out_f);
fputs(_("Start at"), out_f);
fwrite(csp_str51, 1, 2, out_f);
{
  struct tm *ptm = localtime(&(sched_time));
  fprintf(out_f, "%02d:%02d:%02d", ptm->tm_hour, ptm->tm_min, ptm->tm_sec);
}
}
if (start_time > 0 && stop_time <= 0 && duration > 0) {
    duration_str(0, start_time + duration - cs->current_time, 0, time_buf, 0);
fwrite(csp_str50, 1, 3, out_f);
fputs(_("Remaining"), out_f);
fwrite(csp_str52, 1, 26, out_f);
fputs((time_buf), out_f);
fwrite(csp_str41, 1, 6, out_f);
}
fwrite(csp_str53, 1, 42, out_f);
if (global->disable_auto_refresh > 0) {
fwrite(csp_str54, 1, 7, out_f);
} else {
fwrite(csp_str55, 1, 6, out_f);
}
fwrite(csp_str56, 1, 48, out_f);
fputs(_("REFRESH"), out_f);
fwrite(csp_str57, 1, 79, out_f);
ns_get_user_problems_summary(cs, phr->user_id, accepting_mode,
                               solved_flag, accepted_flag, pending_flag,
                               trans_flag, pr_flag,
                               best_run, attempts, disqualified,
                               best_score, prev_successes, all_attempts);
  ns_get_problem_status(cs, phr->user_id, phr->login, accepting_mode,
                        start_time, stop_time,
                        solved_flag, accepted_flag, prob_status);
// top navigation
  if (global->problem_navigation > 0 && start_time > 0 && stop_time <= 0) {
    if (prob_id > cs->max_prob) prob_id = 0;
    if (prob_id > 0 && !(prob = cs->probs[prob_id])) prob_id = 0;
    if (prob_id > 0 && !(prob_status[prob_id] & PROB_STATUS_GOOD))
      prob_id = 0;
    if (prob_id > 0 && prob->variant_num > 0
        && (variant = find_variant(cs, phr->user_id, prob_id, 0)) <= 0)
      prob_id = 0;
fwrite(csp_str58, 1, 30, out_f);
upper_tab_id = prob_id;
    if (global->vertical_navigation <= 0) {
fwrite(csp_str59, 1, 85, out_f);
for (i = 1; i <= cs->max_prob; i++) {
        if (!(prob = cs->probs[i])) continue;
        if (!(prob_status[i] & PROB_STATUS_TABABLE)) continue;
if (i == prob_id) {
fwrite(csp_str60, 1, 25, out_f);
} else {
fwrite(csp_str61, 1, 4, out_f);
}
if (i == prob_id) {
fwrite(csp_str62, 1, 26, out_f);
} else if (!all_attempts[i]) {
fwrite(csp_str63, 1, 24, out_f);
} else if (pending_flag[i] || trans_flag[i]) {
fwrite(csp_str64, 1, 24, out_f);
} else if (accepted_flag[i] || solved_flag[i] || pr_flag[i]) {
fwrite(csp_str65, 1, 21, out_f);
} else if (prob->disable_user_submit > 0) {
fwrite(csp_str66, 1, 27, out_f);
} else {
fwrite(csp_str67, 1, 22, out_f);
}
fputs("<a class=\"tab\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT);
fputs(sep, out_f); sep = "&amp;";
fputs("prob_id=", out_f);
fprintf(out_f, "%d", (int)(i));
(void) sep;
fputs("\">", out_f);
fputs((prob->short_name), out_f);
fputs("</a>", out_f);
fwrite(csp_str68, 1, 11, out_f);
}
fwrite(csp_str69, 1, 84, out_f);
} else {
fwrite(csp_str70, 1, 79, out_f);
}
  }
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_MAIN_PAGE) {
if (!cnts->exam_mode) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Server status"), out_f);
fwrite(csp_str73, 1, 12, out_f);
if (stop_time > 0) {
      if (duration > 0 && global->board_fog_time > 0
          && global->board_unfog_time > 0
          && cs->current_time < stop_time + global->board_unfog_time
          && !cs->standings_updated) {
        if (cnts->exam_mode) {
fputs(_("The exam is over (standings are frozen)"), out_f);
} else {
fputs(_("The contest is over (standings are frozen)"), out_f);
}
      } else if (cnts->exam_mode) {
fputs(_("The exam is over"), out_f);
} else {
fputs(_("The contest is over"), out_f);
}
    } else if (start_time > 0) {
      if (fog_start_time > 0 && cs->current_time >= fog_start_time) {
        if (cnts->exam_mode) {
fputs(_("The exam is in progress (standings are frozen)"), out_f);
} else {
fputs(_("The contest is in progress (standings are frozen)"), out_f);
}
      } else {
        if (cnts->exam_mode) {
fputs(_("The exam is in progress"), out_f);
} else {
fputs(_("The contest is in progress"), out_f);
}
      }
    } else {
      if (cnts->exam_mode) {
fputs(_("The exam is not started"), out_f);
} else {
fputs(_("The contest is not started"), out_f);
}
    }
fwrite(csp_str74, 1, 10, out_f);
if (cs->upsolving_mode) {
fwrite(csp_str75, 1, 6, out_f);
fputs(_("Upsolving mode"), out_f);
fwrite(csp_str76, 1, 8, out_f);
}
fwrite(csp_str77, 1, 2, out_f);
if (start_time > 0) {
      if (global->score_system == SCORE_OLYMPIAD && !global->is_virtual) {
fwrite(csp_str75, 1, 6, out_f);
if (cs->accepting_mode) {
fputs(_("Participants\' solutions are being accepted"), out_f);
} else if (!cs->testing_finished) {
fputs(_("Participants\' solutions are being judged"), out_f);
} else {
fputs(_("Participants\' solutions are judged"), out_f);
}
fwrite(csp_str76, 1, 8, out_f);
}
    }
fwrite(csp_str71, 1, 1, out_f);
if (cs->clients_suspended) {
fwrite(csp_str75, 1, 6, out_f);
fputs(_("Participants\' requests are suspended"), out_f);
fwrite(csp_str76, 1, 8, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (start_time > 0) {
      if (cs->testing_suspended) {
fwrite(csp_str75, 1, 6, out_f);
fputs(_("Testing of participants\' submits is suspended"), out_f);
fwrite(csp_str76, 1, 8, out_f);
}
      if (cs->printing_suspended) {
fwrite(csp_str75, 1, 6, out_f);
fputs(_("Print requests are suspended"), out_f);
fwrite(csp_str76, 1, 8, out_f);
}
    }
fwrite(csp_str78, 1, 40, out_f);
fputs(_("Server time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((cs->current_time)), out_f);
fwrite(csp_str80, 1, 11, out_f);
if (start_time > 0) {
fwrite(csp_str81, 1, 19, out_f);
if (cnts->exam_mode) {
fputs(_("Exam start time"), out_f);
} else {
fputs(_("Contest start time"), out_f);
}
fwrite(csp_str82, 1, 15, out_f);
fputs(xml_unparse_date((start_time)), out_f);
fwrite(csp_str83, 1, 10, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (!global->is_virtual && start_time <= 0 && sched_time > 0) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Planned start time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((sched_time)), out_f);
fwrite(csp_str83, 1, 10, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (stop_time <= 0 && (duration > 0 || finish_time <= 0)) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Duration"), out_f);
fwrite(csp_str79, 1, 21, out_f);
if (duration > 0) {
        duration_str(0, duration, 0, hbuf, 0);
fputs((hbuf), out_f);
} else {
fputs(_("Unlimited"), out_f);
}
fwrite(csp_str83, 1, 10, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (start_time > 0 && stop_time <= 0 && duration > 0) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Scheduled end time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date(((time_t)(start_time + duration))), out_f);
fwrite(csp_str83, 1, 10, out_f);
} else if (start_time > 0 && stop_time <= 0 && duration <= 0 && finish_time > 0) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Scheduled end time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((finish_time)), out_f);
fwrite(csp_str83, 1, 10, out_f);
} else if (stop_time) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("End time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((stop_time)), out_f);
fwrite(csp_str83, 1, 10, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (start_time > 0 && stop_time <= 0 && fog_start_time > 0) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Standings freeze time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((fog_start_time)), out_f);
fwrite(csp_str83, 1, 10, out_f);
} else if (stop_time > 0 && duration > 0 && global->board_fog_time > 0
               && global->board_unfog_time > 0 && !cs->standings_updated
               && cs->current_time < stop_time + global->board_unfog_time) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Standings unfreeze time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date(((time_t)(stop_time + global->board_unfog_time))), out_f);
fwrite(csp_str83, 1, 10, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (start_time > 0 && stop_time <= 0 && duration > 0) {
      duration_str(0, cs->current_time, start_time, hbuf, 0);
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Elapsed time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs((hbuf), out_f);
fwrite(csp_str80, 1, 11, out_f);
duration_str(0, start_time + duration - cs->current_time, 0, hbuf, 0);
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Remaining time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs((hbuf), out_f);
fwrite(csp_str80, 1, 11, out_f);
}
    if (start_time <= 0 && global->is_virtual > 0 && cnts->open_time > 0 && cs->current_time < cnts->open_time) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Virtual contest open time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((cnts->open_time)), out_f);
fwrite(csp_str80, 1, 11, out_f);
}
    if (start_time <= 0 && global->is_virtual > 0 && cnts->close_time > 0) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Virtual contest close time"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs(xml_unparse_date((cnts->close_time)), out_f);
fwrite(csp_str80, 1, 11, out_f);
}
fwrite(csp_str84, 1, 10, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (global->description_file[0]) {
    watched_file_update(&cs->description, global->description_file, cs->current_time);
    if (cs->description.text) {
fputs((cs->description.text), out_f);
}
  }
fwrite(csp_str71, 1, 1, out_f);
if (!cnts->exam_mode) {
fwrite(csp_str75, 1, 6, out_f);
fputs(_("On-line users in this contest"), out_f);
fwrite(csp_str51, 1, 2, out_f);
fprintf(out_f, "%d", (int)(phr->online_users));
fwrite(csp_str85, 1, 9, out_f);
if (cs->max_online_count > 0) {
fwrite(csp_str75, 1, 6, out_f);
fputs(_("Max number of users was"), out_f);
fwrite(csp_str51, 1, 2, out_f);
fprintf(out_f, "%d", (int)(cs->max_online_count));
fwrite(csp_str86, 1, 2, out_f);
fputs(xml_unparse_date((cs->max_online_time)), out_f);
fwrite(csp_str85, 1, 9, out_f);
}
  }
fwrite(csp_str71, 1, 1, out_f);
if (!cnts->exam_mode && global->is_virtual && start_time <= 0) {
    enable_virtual_start = 1;
    if (global->disable_virtual_start > 0) {
      enable_virtual_start = 0;
    } else if (cnts->open_time > 0 && cs->current_time < cnts->open_time) {
      enable_virtual_start = 0;
    } else if (cnts->close_time > 0 && cs->current_time >= cnts->close_time) {
      enable_virtual_start = 0;
    }
    if (enable_virtual_start) {
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
if (cnts->exam_mode) {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_START, _("Start exam")), out_f);
fwrite(csp_str88, 1, 4, out_f);
} else {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_START, NULL), out_f);
fwrite(csp_str88, 1, 4, out_f);
}
fputs("</form>", out_f);
}
  } else if (!cnts->exam_mode && global->is_virtual && stop_time <= 0) {
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
if (cnts->exam_mode) {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_STOP, _("Stop exam")), out_f);
fwrite(csp_str88, 1, 4, out_f);
} else {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_STOP, NULL), out_f);
fwrite(csp_str88, 1, 4, out_f);
}
fputs("</form>", out_f);
}
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_STARTSTOP) {
if (global->is_virtual && start_time <= 0) {
      if (global->disable_virtual_start <= 0) {
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
if (cnts->exam_mode) {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_START, _("Start exam")), out_f);
fwrite(csp_str88, 1, 4, out_f);
} else {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_START, NULL), out_f);
fwrite(csp_str88, 1, 4, out_f);
}
fputs("</form>", out_f);
}
    } else if (global->is_virtual && stop_time <= 0) {
      if (cnts->exam_mode) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Finish the exam"), out_f);
fwrite(csp_str89, 1, 9, out_f);
fputs(_("Press \"Stop exam\" button to finish the exam. Your answers will be checked shortly after that."), out_f);
fwrite(csp_str88, 1, 4, out_f);
}
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
if (cnts->exam_mode) {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_STOP, _("Stop exam")), out_f);
fwrite(csp_str88, 1, 4, out_f);
} else {
fwrite(csp_str87, 1, 3, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIRTUAL_STOP, NULL), out_f);
fwrite(csp_str88, 1, 4, out_f);
}
fputs("</form>", out_f);
}
}
fwrite(csp_str71, 1, 1, out_f);
if (start_time && phr->action == NEW_SRV_ACTION_VIEW_PROBLEM_SUMMARY) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Problem status summary"), out_f);
fwrite(csp_str90, 1, 6, out_f);
if (cnts->exam_mode && global->score_system == SCORE_OLYMPIAD
        && global->is_virtual && stop_time > 0
        && global->disable_virtual_auto_judge > 0
        && !cs->testing_finished) {
      char *ff_txt = 0, *fl_txt = 0;
      size_t ff_len = 0, fl_len = 0;
      FILE *ff = open_memstream(&ff_txt, &ff_len);
      FILE *fl = open_memstream(&fl_txt, &fl_len);
      int rr = ns_olympiad_final_user_report(ff, fl, cnts, cs,
                                             phr->user_id, phr->locale_id);
      if (rr < 0) {
fwrite(csp_str87, 1, 3, out_f);
fputs(_("Error"), out_f);
fwrite(csp_str91, 1, 1, out_f);
fprintf(out_f, "%d", (int)(-rr));
} else {
        close_memstream(fl); fl = 0;
        if (fl_txt && *fl_txt) {
fwrite(csp_str92, 1, 23, out_f);
fputs(html_armor_buf(&ab, (fl_txt)), out_f);
fwrite(csp_str93, 1, 13, out_f);
xfree(fl_txt); fl_txt = 0; fl_len = 0;
          close_memstream(ff); ff = 0; xfree(ff_txt); ff_txt = 0; ff_len = 0;
        } else {
          close_memstream(ff); ff = 0;
fputs((ff_txt), out_f);
xfree(fl_txt); fl_txt = 0; fl_len = 0;
          xfree(ff_txt); ff_txt = 0; ff_len = 0;
        }
      }
    } else if (cnts->exam_mode && global->score_system == SCORE_OLYMPIAD
               && global->is_virtual && stop_time > 0
               && (run_has_transient_user_runs(cs->runlog_state, phr->user_id)
                   || (global->disable_virtual_auto_judge <= 0
                       && !is_judged_virtual_olympiad(cs, phr->user_id)))) {
fwrite(csp_str87, 1, 3, out_f);
fputs(_("Testing is in progress..."), out_f);
fwrite(csp_str88, 1, 4, out_f);
} else {
      if (global->score_system == SCORE_OLYMPIAD
          && global->is_virtual
          && cs->testing_finished)
        accepting_mode = 0;
      if (cs->contest_plugin
          && cs->contest_plugin->generate_html_user_problems_summary) {
        // FIXME: return code and logging stream is not used now
        char *us_text = 0;
        size_t us_size = 0;
        FILE *us_file = open_memstream(&us_text, &us_size);
        (*cs->contest_plugin->generate_html_user_problems_summary)(cs->contest_plugin_data, us_file, out_f, cnts, cs, phr->user_id, accepting_mode, "b1", solved_flag, accepted_flag, pending_flag, trans_flag, best_run, attempts, disqualified, best_score, prev_successes);
        close_memstream(us_file); us_file = 0;
        xfree(us_text); us_text = 0;
      } else {
        ns_write_user_problems_summary(cnts, cs, out_f, phr->user_id,
                                       accepting_mode, "b1",
                                       solved_flag, accepted_flag, pr_flag, pending_flag,
                                       trans_flag, best_run, attempts,
                                       disqualified, best_score);
      }
    }
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_PROBLEM_STATEMENTS && start_time > 0) {
if (cnts->problems_url && *cnts->problems_url) {
fwrite(csp_str94, 1, 12, out_f);
fputs((cnts->problems_url), out_f);
fwrite(csp_str32, 1, 18, out_f);
fputs(_("Problem statements"), out_f);
fwrite(csp_str95, 1, 9, out_f);
}
// if prob_id == -1, show all available problem statements
    if (prob_id == -1) {
      first_prob_id = 1;
      last_prob_id = cs->max_prob;
    } else {
      first_prob_id = prob_id;
      last_prob_id = prob_id;
    }
    for (prob_id = first_prob_id; prob_id <= last_prob_id; prob_id++) {
      variant = 0;
      if (prob_id <= 0 || prob_id > cs->max_prob) continue;
      if (!(prob = cs->probs[prob_id])) continue;
      if (!serve_is_problem_started(cs, phr->user_id, prob)) continue;
      if (serve_is_problem_deadlined(cs, phr->user_id, phr->login,
                                     prob, &prob_deadline[prob_id]))
        continue;
      if (prob->variant_num > 0
          && (variant = find_variant(cs, phr->user_id, prob_id, 0)) <= 0)
        continue;
      if (!prob->statement_file[0]) continue;
      if (variant > 0) {
        prepare_insert_variant_num(variant_stmt_file, sizeof(variant_stmt_file),
                                   prob->statement_file, variant);
        pw = &cs->prob_extras[prob_id].v_stmts[variant];
        pw_path = variant_stmt_file;
      } else {
        pw = &cs->prob_extras[prob_id].stmt;
        pw_path = prob->statement_file;
      }
      watched_file_update(pw, pw_path, cs->current_time);
      if (!pw->text) continue;

      fprintf(out_f, "%s", pw->text);
    }
fwrite(csp_str96, 1, 5, out_f);
fputs(_("Select another problem"), out_f);
fwrite(csp_str90, 1, 6, out_f);
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str97, 1, 39, out_f);
fputs(_("Problem"), out_f);
fwrite(csp_str79, 1, 21, out_f);
html_problem_selection_2(cs, out_f, phr, 0, start_time);
fwrite(csp_str98, 1, 20, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIEW_PROBLEM_STATEMENTS, _("Select problem")), out_f);
fwrite(csp_str99, 1, 19, out_f);
fputs("</form>", out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT && !cs->clients_suspended) {
if (prob_id > cs->max_prob) prob_id = 0;
    if (prob_id > 0 && !(prob = cs->probs[prob_id])) prob_id = 0;
    if (prob_id > 0 && !serve_is_problem_started(cs, phr->user_id, prob))
      prob_id = 0;
    if (prob_id > 0 && serve_is_problem_deadlined(cs, phr->user_id, phr->login,
                                                  prob,
                                                  &prob_deadline[prob_id]))
      prob_id = 0;
    //if (prob_id > 0 && prob->disable_user_submit > 0) prob_id = 0;
    if (prob_id > 0 && prob->variant_num > 0
        && (variant = find_variant(cs, phr->user_id, prob_id, 0)) <= 0)
      prob_id = 0;

    if (start_time > 0 && stop_time <= 0 && !prob_id) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("View the problem statement and send a submission"), out_f);
fwrite(csp_str90, 1, 6, out_f);
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str97, 1, 39, out_f);
fputs(_("Problem"), out_f);
fwrite(csp_str79, 1, 21, out_f);
html_problem_selection(cs, out_f, phr, solved_flag, accepted_flag, 0, 0, start_time);
fwrite(csp_str98, 1, 20, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT, _("Select problem")), out_f);
fwrite(csp_str99, 1, 19, out_f);
fputs("</form>", out_f);
fwrite(csp_str71, 1, 1, out_f);
} /* 14 */ else if (start_time > 0 && stop_time <= 0 && prob_id > 0) {
      prob = cs->probs[prob_id];

      dbuf[0] = 0;
      if ((prob_status[prob_id] & PROB_STATUS_SUBMITTABLE)
          && prob_deadline[prob_id] > 0) {
        snprintf(dbuf, sizeof(dbuf), "<h3>%s: %s</h3>",
                 _("Problem deadline"),
                 xml_unparse_date(prob_deadline[prob_id]));
      }

      bb[0] = 0;
      if (variant > 0) {
        snprintf(bb, sizeof(bb), "<%s>%s %s-%s (%s %d)</%s>%s\n",
                 cnts->team_head_style,
                 (prob_status[prob_id] & PROB_STATUS_SUBMITTABLE)?_("Submit a solution for"):_("Problem"),
                 prob->short_name, prob->long_name, _("Variant"), variant,
                 cnts->team_head_style, dbuf);
      } else {
        if (cnts->exam_mode) {
          /*
          if (prob->disable_user_submit > 0) {
            snprintf(bb, sizeof(bb), "<%s>%s</%s>\n",
                     cnts->team_head_style,
                     prob->long_name, cnts->team_head_style);
          } else {
            snprintf(bb, sizeof(bb), "<%s>%s %s</%s>\n",
                     cnts->team_head_style, _("Submit a solution for"),
                     prob->long_name, cnts->team_head_style);
          }
          */
          snprintf(bb, sizeof(bb), "<%s>%s %s</%s>%s\n",
                   cnts->team_head_style, _("Problem"),
                   prob->long_name, cnts->team_head_style, dbuf);
        } else {
          if (1 /*!(prob_status[prob_id] & PROB_STATUS_SUBMITTABLE)*/) {
            if (prob->long_name[0]) {
              snprintf(bb, sizeof(bb), "<%s>%s %s-%s</%s>%s\n",
                       cnts->team_head_style, _("Problem"),
                       prob->short_name, prob->long_name, cnts->team_head_style,
                       dbuf);
            } else {
              snprintf(bb, sizeof(bb), "<%s>%s %s</%s>%s\n",
                       cnts->team_head_style, _("Problem"),
                       prob->short_name, cnts->team_head_style, dbuf);
            }
          } else {
            if (prob->long_name[0]) {
              snprintf(bb, sizeof(bb), "<%s>%s %s-%s</%s>%s\n",
                       cnts->team_head_style, _("Submit a solution for"),
                       prob->short_name, prob->long_name, cnts->team_head_style,
                       dbuf);
            } else {
              snprintf(bb, sizeof(bb), "<%s>%s %s</%s>%s\n",
                       cnts->team_head_style, _("Submit a solution for"),
                       prob->short_name, cnts->team_head_style, dbuf);
            }
          }
        }
      }
if (prob->max_user_run_count > 0) {
        int ignored_set = 0;
        if (prob->ignore_compile_errors > 0) ignored_set |= 1 << RUN_COMPILE_ERR;
        ignored_set |= 1 << RUN_IGNORED;
        int remain_count = prob->max_user_run_count - run_count_all_attempts_2(cs->runlog_state, phr->user_id, prob_id, ignored_set);
        if (remain_count < 0) remain_count = 0;
fwrite(csp_str100, 1, 4, out_f);
fputs(_("Remaining attempts"), out_f);
fwrite(csp_str51, 1, 2, out_f);
fprintf(out_f, "%d", (int)(remain_count));
fwrite(csp_str101, 1, 6, out_f);
if (remain_count <= 0) prob_status[prob_id] &= ~PROB_STATUS_SUBMITTABLE;
      }
px = 0;
      if (variant > 0 && prob->xml.a && prob->xml.a[variant - 1]) {
        px = prob->xml.a[variant - 1];
      } else if (variant <= 0 && prob->xml.p) {
        px = prob->xml.p;
      }

      /* put problem statement */
      if (px && px->stmts) {
        ns_unparse_statement(out_f, phr, cnts, extra, prob, 0, px, bb,
                          prob_status[prob_id] & PROB_STATUS_SUBMITTABLE);
      } else if (prob->statement_file[0]
          && (prob_status[prob_id] & PROB_STATUS_VIEWABLE)) {
        if (variant > 0) {
          prepare_insert_variant_num(variant_stmt_file,
                                     sizeof(variant_stmt_file),
                                     prob->statement_file, variant);
          pw = &cs->prob_extras[prob_id].v_stmts[variant];
          pw_path = variant_stmt_file;
        } else {
          pw = &cs->prob_extras[prob_id].stmt;
          pw_path = prob->statement_file;
        }
        watched_file_update(pw, pw_path, cs->current_time);
        if (!pw->text) {
fputs((bb), out_f);
fwrite(csp_str102, 1, 26, out_f);
fputs(_("The problem statement is not available"), out_f);
fwrite(csp_str103, 1, 18, out_f);
} else {
          if (cnts->exam_mode) bb[0] = 0;
          fprintf(out_f, "%s", bb);
          if ((prob_status[prob_id] & PROB_STATUS_SUBMITTABLE)
              && prob->type == PROB_TYPE_CUSTOM) {
            html_start_form(out_f, 2, phr->self_url, phr->hidden_vars);
            skip_start_form = 1;
          }
          fprintf(out_f, "%s", pw->text);
        }
      } else {
        fprintf(out_f, "%s", bb);
      }

      if ((prob_status[prob_id] & PROB_STATUS_SUBMITTABLE)) {
        if (!skip_start_form) {
fputs("<form method=\"post\" enctype=\"multipart/form-data\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
}
fputs("<input type=\"hidden\" name=\"prob_id\"", out_f);
if ((prob_id)) {
fputs(" value=\"", out_f);
fprintf(out_f, "%d", (int)(prob_id));
fputs("\"", out_f);
}
fputs(" />", out_f);
fwrite(csp_str104, 1, 20, out_f);
if (!prob->type) {
          int last_eoln_type = 0;
          for (i = 1; i <= cs->max_lang; i++) {
            if (!cs->langs[i] || cs->langs[i]->disabled
                || (cs->langs[i]->insecure && global->secure_run)) continue;
            if ((lang_list = prob->enable_language)) {
              for (j = 0; lang_list[j]; j++)
                if (!strcmp(lang_list[j], cs->langs[i]->short_name))
                  break;
              if (!lang_list[j]) continue;
            } else if ((lang_list = prob->disable_language)) {
              for (j = 0; lang_list[j]; j++)
                if (!strcmp(lang_list[j], cs->langs[i]->short_name))
                  break;
              if (lang_list[j]) continue;
            }
            lang_count++;
            lang_id = i;
          }

          if (lang_count == 1) {
fputs("<input type=\"hidden\" name=\"lang_id\"", out_f);
if ((lang_id)) {
fputs(" value=\"", out_f);
fprintf(out_f, "%d", (int)(lang_id));
fputs("\"", out_f);
}
fputs(" />", out_f);
fwrite(csp_str105, 1, 20, out_f);
fputs(_("Language"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs((cs->langs[lang_id]->short_name), out_f);
fwrite(csp_str106, 1, 3, out_f);
fputs(html_armor_buf(&ab, (cs->langs[lang_id]->long_name)), out_f);
fwrite(csp_str80, 1, 11, out_f);
} else {
            last_lang_id = get_last_language(cs, phr->user_id, &last_eoln_type);
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Language"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<select name=\"lang_id\"", out_f);
fputs(">", out_f);
fwrite(csp_str107, 1, 26, out_f);
for (i = 1; i <= cs->max_lang; i++) {
              if (!cs->langs[i] || cs->langs[i]->disabled
                  || (cs->langs[i]->insecure && global->secure_run)) continue;
              if ((lang_list = prob->enable_language)) {
                for (j = 0; lang_list[j]; j++)
                  if (!strcmp(lang_list[j], cs->langs[i]->short_name))
                    break;
                if (!lang_list[j]) continue;
              } else if ((lang_list = prob->disable_language)) {
                for (j = 0; lang_list[j]; j++)
                  if (!strcmp(lang_list[j], cs->langs[i]->short_name))
                    break;
                if (lang_list[j]) continue;
              }
fputs("<option", out_f);
if (last_lang_id == i) {
fputs(" selected=\"selected\"", out_f);
}
fputs(" value=\"", out_f);
fprintf(out_f, "%d", (int)(i));
fputs("\"", out_f);
fputs(">", out_f);
fputs((cs->langs[i]->short_name), out_f);
fwrite(csp_str106, 1, 3, out_f);
fputs(html_armor_buf(&ab, (cs->langs[i]->long_name)), out_f);
fputs("</option>", out_f);
}
fputs("</select>", out_f);
fwrite(csp_str80, 1, 11, out_f);
}
if (cs->global->enable_eoln_select > 0) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Desired EOLN Type"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<select name=\"eoln_type\"", out_f);
fputs(">", out_f);
fwrite(csp_str108, 1, 29, out_f);
fputs("<option", out_f);
if (last_eoln_type == 1) {
fputs(" selected=\"selected\"", out_f);
}
fputs(" value=\"", out_f);
fprintf(out_f, "%d", (int)(1));
fputs("\"", out_f);
fputs(">", out_f);
fwrite(csp_str109, 1, 15, out_f);
fputs("</option>", out_f);
fwrite(csp_str71, 1, 1, out_f);
fputs("<option", out_f);
if (last_eoln_type == 2) {
fputs(" selected=\"selected\"", out_f);
}
fputs(" value=\"", out_f);
fprintf(out_f, "%d", (int)(2));
fputs("\"", out_f);
fputs(">", out_f);
fwrite(csp_str110, 1, 18, out_f);
fputs("</option>", out_f);
fwrite(csp_str71, 1, 1, out_f);
fputs("</select>", out_f);
fwrite(csp_str80, 1, 11, out_f);
}
        }
switch (prob->type) {
          /*
        case PROB_TYPE_STANDARD:
          fprintf(out_f, "<tr><td class=\"b0\">%s</td><td class=\"b0\"><input type=\"file\" name=\"file\"/></td></tr>", _("File"));
          break;
          */
        case PROB_TYPE_STANDARD:
        case PROB_TYPE_OUTPUT_ONLY:
        case PROB_TYPE_TESTS:
          if (prob->enable_text_form > 0) {
fwrite(csp_str111, 1, 100, out_f);
}
fwrite(csp_str81, 1, 19, out_f);
fputs(_("File"), out_f);
fwrite(csp_str112, 1, 63, out_f);
break;
        case PROB_TYPE_SHORT_ANSWER:
          last_source = 0;
          if (cnts->exam_mode) {
            last_source = get_last_source(cs, phr->user_id, prob->id);
          }
          if (last_source) {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Answer"), out_f);
fwrite(csp_str98, 1, 20, out_f);
fputs("<input type=\"text\" name=\"file\"", out_f);
if ((last_source)) {
fputs(" value=\"", out_f);
fputs(html_armor_buf(&ab, (last_source)), out_f);
fputs("\"", out_f);
}
fputs(" />", out_f);
fwrite(csp_str80, 1, 11, out_f);
} else {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Answer"), out_f);
fwrite(csp_str113, 1, 64, out_f);
}
          xfree(last_source); last_source = 0;
          break;
        case PROB_TYPE_TEXT_ANSWER:
fwrite(csp_str114, 1, 95, out_f);
break;
        case PROB_TYPE_SELECT_ONE:
          last_answer = -1;
          if (cnts->exam_mode) {
            last_answer = get_last_answer_select_one(cs, phr->user_id,
                                                     prob->id);
          }

          if (px) {
            next_prob_id = prob->id;
            if (cnts->exam_mode) {
              if (prob->advance_to_next > 0) {
                next_prob_id++;
                for (; next_prob_id <= cs->max_prob; next_prob_id++) {
                  if (!(prob2 = cs->probs[next_prob_id])) continue;
                  if (!serve_is_problem_started(cs, phr->user_id, prob2))
                    continue;
                  break;
                }
                if (next_prob_id > cs->max_prob) next_prob_id = prob->id;
              }
              ns_unparse_answers(out_f, phr, cnts, extra, prob, variant,
                                 px, 0 /* lang */, 1 /* is_radio */,
                                 last_answer, next_prob_id,
                                 1 /* js_flag */, "b0");
            } else {
              ns_unparse_answers(out_f, phr, cnts, extra, prob, variant,
                                 px, 0 /* lang */, 1 /* is_radio */,
                                 last_answer, next_prob_id,
                                 0 /* js_flag */, "b0");
            }
          } else if (prob->alternative) {
            for (i = 0; prob->alternative[i]; i++) {
              cc = "";
              if (i + 1 == last_answer) cc = " checked=\"1\"";
              fprintf(out_f, "<tr><td class=\"b0\">%d</td><td class=\"b0\"><input type=\"radio\" name=\"file\" value=\"%d\"%s/></td><td>%s</td></tr>", i + 1, i + 1, cc, prob->alternative[i]);
            }
          }
          break;
        case PROB_TYPE_SELECT_MANY:
          if (prob->alternative) {
            for (i = 0; prob->alternative[i]; i++) {
              fprintf(out_f, "<tr><td class=\"b0\">%d</td><td class=\"b0\"><input type=\"checkbox\" name=\"ans_%d\"/></td><td>%s</td></tr>", i + 1, i + 1, prob->alternative[i]);
            }
          }
          break;
        case PROB_TYPE_CUSTOM:
          break;
        }
        if (cnts->exam_mode) {
          if (prob->type != PROB_TYPE_SELECT_ONE) {
            cc = "";
            if (prob && (prob->type == PROB_TYPE_SELECT_MANY || prob->type == PROB_TYPE_SELECT_ONE)) cc = "<td class=\"b0\">&nbsp;</td>";
            fprintf(out_f, "<tr>%s<td class=\"b0\">&nbsp;</td><td class=\"b0\">%s</td></tr></table></form>", cc,
                    ns_submit_button(bb, sizeof(bb), 0,
                                     NEW_SRV_ACTION_SUBMIT_RUN,
                                     _("Submit solution!")));
          } else {
            fprintf(out_f, "</tr></table></form>");
          }
        } else {
fwrite(csp_str81, 1, 19, out_f);
fputs(_("Send!"), out_f);
fwrite(csp_str98, 1, 20, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_SUBMIT_RUN, NULL), out_f);
fwrite(csp_str115, 1, 26, out_f);
}
      } /* prob->disable_user_submit <= 0 */
if (global->problem_navigation
          //&& !prob->disable_user_submit
          && prob->type != PROB_TYPE_SELECT_ONE
          && all_attempts[prob->id]) {
        if (all_attempts[prob->id] <= 15) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Previous submissions of this problem"), out_f);
fwrite(csp_str90, 1, 6, out_f);
} else {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Previous submissions of this problem"), out_f);
fwrite(csp_str116, 1, 2, out_f);
fputs(_("last 15"), out_f);
fwrite(csp_str117, 1, 7, out_f);
}
        if (cs->contest_plugin && cs->contest_plugin->generate_html_user_runs){
          // FIXME: logged output is also ignored
          // FIXME: return code is ignored for now
          char *ur_text = 0;
          size_t ur_size = 0;
          FILE *ur_file = open_memstream(&ur_text, &ur_size);
          (*cs->contest_plugin->generate_html_user_runs)(cs->contest_plugin_data, ur_file, out_f, cnts, cs, phr, phr->user_id, prob_id, all_runs, "b1");
          close_memstream(ur_file); ur_file = 0;
          xfree(ur_text); ur_text = 0;
        } else if (global->score_system == SCORE_OLYMPIAD) {
          ns_write_olympiads_user_runs(phr, out_f, cnts, extra, all_runs,
                                       prob_id, "b1");
        } else {
          new_write_user_runs(cs, out_f, phr, all_runs, prob->id, "b1");
        }
      }
if (!cnts->exam_mode) {
        if (global->problem_navigation <= 0) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Select another problem"), out_f);
fwrite(csp_str90, 1, 6, out_f);
} else {
          /*
          fprintf(out_f, "<%s>%s</%s>\n",
                  cnts->team_head_style, _("Problem navigation"),
                  cnts->team_head_style);
          */
        }
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str118, 1, 25, out_f);
if (global->problem_navigation > 0) {
          for (i = prob_id - 1; i > 0; i--) {
            if (!(prob_status[i] & PROB_STATUS_GOOD)) continue;
            break;
          }
          if (i > 0) {
fwrite(csp_str71, 1, 1, out_f);
fwrite(csp_str82, 1, 15, out_f);
fputs("<a href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT);
fputs(sep, out_f); sep = "&amp;";
fputs("prob_id=", out_f);
fprintf(out_f, "%d", (int)(i));
(void) sep;
fputs("\">", out_f);
fputs(_("Previous problem"), out_f);
fputs("</a>", out_f);
fwrite(csp_str119, 1, 5, out_f);
}
        }

        if (global->problem_navigation <= 0) {
fwrite(csp_str82, 1, 15, out_f);
fputs(_("Problem"), out_f);
fwrite(csp_str79, 1, 21, out_f);
html_problem_selection(cs, out_f, phr, solved_flag, accepted_flag, 0, 0, start_time);
fwrite(csp_str98, 1, 20, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT, NULL), out_f);
fwrite(csp_str119, 1, 5, out_f);
}

        if (global->problem_navigation > 0) {
          for (i = prob_id + 1; i <= cs->max_prob; i++) {
            if (!(prob_status[i] & PROB_STATUS_GOOD)) continue;
            break;
          }
          if (i <= cs->max_prob) {
fwrite(csp_str71, 1, 1, out_f);
fwrite(csp_str82, 1, 15, out_f);
fputs("<a href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT);
fputs(sep, out_f); sep = "&amp;";
fputs("prob_id=", out_f);
fprintf(out_f, "%d", (int)(i));
(void) sep;
fputs("\">", out_f);
fputs(_("Next problem"), out_f);
fputs("</a>", out_f);
fwrite(csp_str119, 1, 5, out_f);
}
        }
fwrite(csp_str120, 1, 14, out_f);
fputs("</form>", out_f);
fwrite(csp_str71, 1, 1, out_f);
}
    }
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_SUBMISSIONS && start_time > 0) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Sent submissions"), out_f);
fwrite(csp_str116, 1, 2, out_f);
if (all_runs) {
fputs(_("all"), out_f);
} else {
fputs(_("last 15"), out_f);
}
fwrite(csp_str117, 1, 7, out_f);
if (cs->contest_plugin && cs->contest_plugin->generate_html_user_runs){
      // FIXME: logged output is also ignored
      // FIXME: return code is ignored for now
      char *ur_text = 0;
      size_t ur_size = 0;
      FILE *ur_file = open_memstream(&ur_text, &ur_size);
      (*cs->contest_plugin->generate_html_user_runs)(cs->contest_plugin_data, ur_file, out_f, cnts, cs, phr, phr->user_id, 0, all_runs, "b1");
      close_memstream(ur_file); ur_file = 0;
      xfree(ur_text); ur_text = 0;
    } else if (global->score_system == SCORE_OLYMPIAD) {
ns_write_olympiads_user_runs(phr, out_f, cnts, extra, all_runs, 0, "b1");
} else {
new_write_user_runs(cs, out_f, phr, all_runs, 0, "b1");
}
fwrite(csp_str71, 1, 1, out_f);
fwrite(csp_str121, 1, 5, out_f);
fwrite(csp_str122, 1, 4, out_f);
fputs("<a href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_SUBMISSIONS);
fputs(sep, out_f); sep = "&amp;";
fputs("all_runs=", out_f);
fprintf(out_f, "%d", (int)((int) !all_runs));
(void) sep;
fputs("\">", out_f);
if (all_runs) {
fputs(_("View last 15"), out_f);
} else {
fputs(_("View all"), out_f);
}
fputs("</a>", out_f);
fwrite(csp_str123, 1, 5, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_CLAR_SUBMIT && !cs->clients_suspended) {
if (!global->disable_clars && !global->disable_team_clars && start_time > 0 && stop_time <= 0) {
fwrite(csp_str96, 1, 5, out_f);
fputs(_("Send a message to judges"), out_f);
fwrite(csp_str90, 1, 6, out_f);
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str124, 1, 38, out_f);
fputs(_("Problem"), out_f);
fwrite(csp_str79, 1, 21, out_f);
html_problem_selection(cs, out_f, phr, solved_flag, accepted_flag, 0, 1, start_time);
fwrite(csp_str125, 1, 30, out_f);
fputs(_("Subject"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<input type=\"text\" name=\"subject\" size=\"40\" />", out_f);
fwrite(csp_str126, 1, 137, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_SUBMIT_CLAR, NULL), out_f);
fwrite(csp_str127, 1, 20, out_f);
fputs("</form>", out_f);
fwrite(csp_str71, 1, 1, out_f);
}
if (!global->disable_clars && !global->disable_team_clars
        && start_time > 0 && stop_time > 0
        && global->appeal_deadline > 0
        && cs->current_time < global->appeal_deadline) {
fwrite(csp_str96, 1, 5, out_f);
fputs(_("Send an appeal"), out_f);
fwrite(csp_str90, 1, 6, out_f);
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str124, 1, 38, out_f);
fputs(_("Problem"), out_f);
fwrite(csp_str79, 1, 21, out_f);
html_problem_selection(cs, out_f, phr, solved_flag, accepted_flag, 0, 1, start_time);
fwrite(csp_str125, 1, 30, out_f);
fputs(_("Test number"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<input type=\"text\" name=\"test\" size=\"40\" />", out_f);
fwrite(csp_str126, 1, 137, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_SUBMIT_APPEAL, NULL), out_f);
fwrite(csp_str127, 1, 20, out_f);
fputs("</form>", out_f);
fwrite(csp_str71, 1, 1, out_f);
}
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_CLARS && !global->disable_clars) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Messages"), out_f);
fwrite(csp_str116, 1, 2, out_f);
if(all_clars) {
fputs(_("all"), out_f);
} else {
fputs(_("last 15"), out_f);
}
fwrite(csp_str117, 1, 7, out_f);
new_write_user_clars(cs, out_f, phr, all_clars, "b1");
fwrite(csp_str71, 1, 1, out_f);
fwrite(csp_str121, 1, 5, out_f);
fwrite(csp_str122, 1, 4, out_f);
fputs("<a href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_CLARS);
fputs(sep, out_f); sep = "&amp;";
fputs("all_clars=", out_f);
fprintf(out_f, "%d", (int)((int) !all_clars));
(void) sep;
fputs("\">", out_f);
if (all_clars) {
fputs(_("View last 15"), out_f);
} else {
fputs(_("View all"), out_f);
}
fputs("</a>", out_f);
fwrite(csp_str123, 1, 5, out_f);
}
fwrite(csp_str71, 1, 1, out_f);
if (phr->action == NEW_SRV_ACTION_VIEW_SETTINGS) {
if (!cs->clients_suspended && !cnts->disable_password_change) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Change password"), out_f);
fwrite(csp_str90, 1, 6, out_f);
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str97, 1, 39, out_f);
fputs(_("Old password"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<input type=\"password\" name=\"oldpasswd\" size=\"16\" />", out_f);
fwrite(csp_str125, 1, 30, out_f);
fputs(_("New password"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<input type=\"password\" name=\"newpasswd1\" size=\"16\" />", out_f);
fwrite(csp_str125, 1, 30, out_f);
fputs(_("Retype new password"), out_f);
fwrite(csp_str79, 1, 21, out_f);
fputs("<input type=\"password\" name=\"newpasswd2\" size=\"16\" />", out_f);
fwrite(csp_str128, 1, 42, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_CHANGE_PASSWORD, _("Change!")), out_f);
fwrite(csp_str129, 1, 19, out_f);
fputs("</form>", out_f);
fwrite(csp_str71, 1, 1, out_f);
}
#if CONF_HAS_LIBINTL - 0 == 1
    if (global->enable_l10n && !cs->clients_suspended && !cnts->disable_locale_change) {
fwrite(csp_str72, 1, 4, out_f);
fputs(_("Change language"), out_f);
fwrite(csp_str90, 1, 6, out_f);
fputs("<form method=\"post\" enctype=\"application/x-www-form-urlencoded\" action=\"", out_f);
fputs(phr->self_url, out_f);
fputs("\">", out_f);
if (phr->hidden_vars) { fputs(phr->hidden_vars, out_f); }
fwrite(csp_str124, 1, 38, out_f);
fputs(_("Change language"), out_f);
fwrite(csp_str130, 1, 21, out_f);
l10n_html_locale_select(out_f, phr->locale_id);
fwrite(csp_str130, 1, 21, out_f);
fputs(ns_submit_button(hbuf, sizeof(hbuf), 0, NEW_SRV_ACTION_CHANGE_LANGUAGE, _("Change")), out_f);
fwrite(csp_str99, 1, 19, out_f);
fputs("</form>", out_f);
fwrite(csp_str71, 1, 1, out_f);
}
#endif /* CONF_HAS_LIBINTL */
}
fwrite(csp_str71, 1, 1, out_f);
/* new problem navigation */
  if (global->problem_navigation > 0 && global->vertical_navigation > 0 && start_time > 0 && stop_time <= 0) {
// vertical navigation bar
fwrite(csp_str131, 1, 61, out_f);
prev_group_name[0] = 0;

    for (i = 1, j = 0; i <= cs->max_prob; i++) {
      if (!(prob = cs->probs[i])) continue;
      if (!(prob_status[i] & PROB_STATUS_TABABLE)) continue;

      if (prob->group_name[0] && strcmp(prob->group_name, prev_group_name)) {
fwrite(csp_str132, 1, 26, out_f);
fputs((prob->group_name), out_f);
fwrite(csp_str41, 1, 6, out_f);
snprintf(prev_group_name, sizeof(prev_group_name), "%s", prob->group_name);
      }
if (i == prob_id) {
fwrite(csp_str133, 1, 25, out_f);
} else if (!all_attempts[i]) {
fwrite(csp_str134, 1, 23, out_f);
} else if (pending_flag[i] || trans_flag[i]) {
fwrite(csp_str135, 1, 23, out_f);
} else if (accepted_flag[i] || solved_flag[i] || pr_flag[i]) {
fwrite(csp_str136, 1, 20, out_f);
} else if (prob->disable_user_submit > 0) {
fwrite(csp_str132, 1, 26, out_f);
} else {
fwrite(csp_str137, 1, 21, out_f);
}
fputs("<a class=\"tab\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT);
fputs(sep, out_f); sep = "&amp;";
fputs("prob_id=", out_f);
fprintf(out_f, "%d", (int)(i));
(void) sep;
fputs("\">", out_f);
fputs((prob->short_name), out_f);
fputs("</a>", out_f);
fwrite(csp_str41, 1, 6, out_f);
j++;
    }
fwrite(csp_str99, 1, 19, out_f);
} else if (global->problem_navigation > 0 && start_time > 0 && stop_time <= 0) {
// bottom navigation bar
fwrite(csp_str138, 1, 111, out_f);
for (i = 1; i <= cs->max_prob; i++) {
      if (!(prob = cs->probs[i])) continue;
      if (!(prob_status[i] & PROB_STATUS_TABABLE)) continue;
if (i == upper_tab_id) {
fwrite(csp_str139, 1, 28, out_f);
} else {
fwrite(csp_str61, 1, 4, out_f);
}
if (i == upper_tab_id) {
fwrite(csp_str62, 1, 26, out_f);
} else if (!all_attempts[i]) {
fwrite(csp_str63, 1, 24, out_f);
} else if (pending_flag[i] || trans_flag[i]) {
fwrite(csp_str64, 1, 24, out_f);
} else if (accepted_flag[i] || solved_flag[i] || pr_flag[i]) {
fwrite(csp_str65, 1, 21, out_f);
} else if (prob->disable_user_submit > 0) {
fwrite(csp_str66, 1, 27, out_f);
} else {
fwrite(csp_str67, 1, 22, out_f);
}
fputs("<a class=\"tab\" href=\"", out_f);
sep = ns_url_2(out_f, phr, NEW_SRV_ACTION_VIEW_PROBLEM_SUBMIT);
fputs(sep, out_f); sep = "&amp;";
fputs("prob_id=", out_f);
fprintf(out_f, "%d", (int)(i));
(void) sep;
fputs("\">", out_f);
fputs((prob->short_name), out_f);
fputs("</a>", out_f);
fwrite(csp_str68, 1, 11, out_f);
}
fwrite(csp_str140, 1, 24, out_f);
}
fwrite(csp_str141, 1, 17, out_f);
write_copyright_short(out_f);
fwrite(csp_str142, 1, 37, out_f);
l10n_setlocale(0);
//cleanup:;
  html_armor_free(&ab);
  return retval;
}
