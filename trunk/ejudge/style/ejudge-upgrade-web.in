#! /bin/bash
# $Id$
# Copyright (c) 2008-2014 Alexander Chernov <cher@ejudge.ru>

# This script upgrades the web installation of the ejudge system

prefix="@prefix@"
exec_prefix="@exec_prefix@"
bindir="@bindir@"
datarootdir="@datarootdir@"
datadir="@datadir@"
includedir="@includedir@"
libdir="@libdir@"
libexecdir="@libexecdir@"

dflt_httpd_cgi_bin_dir="@ac_cv_httpd_cgi_bin_dir@"
dflt_httpd_htdocs_dir="@ac_cv_httpd_htdocs_dir@"
style_prefix="@ac_cv_style_prefix@"
ejudge_cgibindir="@cgibindir@"
cgi_suffix="@ac_cv_cgi_suffix@"

write_help() {
    echo "ejudge-upgrade-web: ejudge web upgrade utility"
    echo "Copyright (c) 2008-2014 Alexander Chernov <cher@ejudge.ru>"
    echo "usage: ejudge-upgrade-web [HTDOCROOT] [CGIBINDIR] [DOJOPATH/SAVEDIR]"
    exit 0
}

die() {
    echo "ejudge-upgrade-web:" "$@" 2>&1
    exit 1
}

checked_sln() {
if [ "${copy_mode}" = 1 ]
then
    if ! cp -rp "$1" "$2"
    then
        die "cannot copy $1 to $2"
    fi
else
    if ! ln -sf "$1" "$2"
    then
        die "cannot symlink $1 to $2"
    fi
fi
}

if [ "$1" = "--version" ]; then exec "${bindir}/ejudge-config" --version; fi
if [ "$1" = "--help" ]; then write_help; fi

copy_mode=0
if [ "$1" = "--copy" ]; then copy_mode=1; shift; fi
htdocsroot="$1"
cgibindir="$2"
dojodir="$3"

current_dir=`pwd`

[ "${htdocsroot}" != "" ] || htdocsroot="${dflt_httpd_htdocs_dir}"
[ "${cgibindir}" != "" ] || cgibindir="${dflt_httpd_cgi_bin_dir}"

[ -d "${htdocsroot}" ] || die "${htdocsroot} is not a directory"
[ -d "${cgibindir}" ] || die "${cgibindir} is not a directory"


target="${htdocsroot}${style_prefix}"

if [ ! -e "${target}" ]
then
    if ! mkdir "${target}"
    then
        die "cannot create ${target} directory"
    fi
fi

# remove old stuff
# actions.js dojo.js* Storage_* flash6_* storage_* src
cd "${target}"
if ! rm -fr actions.js dojo.js* storage_* flash6_* storage_* src dojo dojox dijit icons
then
    die "cannot remove old files from ${target}"
fi

# symlink the necessary style files
for i in back_sh.png capabilities_sh.png ejudge3.css ejudge3_ss.css filter_expr.html g_bl_light1.jpg grad2.jpg grad_gr_darker.jpg grad_green_long.jpg grad_grey_d.jpg grad.jpg group_sh.png icons logo3.png logo.gif logout_sh.png mapping_sh.png new_cont_sh.png priv.css priv.js refresh_sh.png settings_sh.png sprintf.js unpriv3.css unpriv.css unpriv.js user_sh.png dijit dojo dojox
do
    if [ "${copy_mode}" = 1 ]
    then
        rm -f "${i}"
        if ! cp -rp "${datadir}/ejudge/style/${i}" "${i}"
        then
            die "cannot copy ${datadir}/ejudge/style/${i} to ${i}"
        fi
    else
        if ! ln -sf "${datadir}/ejudge/style/${i}" "${i}"
        then
            die "cannot symlink ${datadir}/ejudge/style/${i} to ${i}"
        fi
    fi
done

# symlink the CGI programs
cd "${cgibindir}"
rm -f "client${cgi_suffix}" "master${cgi_suffix}" "new-judge${cgi_suffix}" "new-register${cgi_suffix}" "serve-control${cgi_suffix}" "users${cgi_suffix}" "judge${cgi_suffix}" "new-client${cgi_suffix}" "new-master${cgi_suffix}" "register${cgi_suffix}" "team${cgi_suffix}"

checked_sln "${ejudge_cgibindir}/serve-control${cgi_suffix}" "serve-control${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/users${cgi_suffix}" "users${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "new-client${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "client${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "team${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "new-register${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "register${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "new-master${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "master${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "new-judge${cgi_suffix}"
checked_sln "${ejudge_cgibindir}/new-client${cgi_suffix}" "judge${cgi_suffix}"

#echo "upgrade complete"
